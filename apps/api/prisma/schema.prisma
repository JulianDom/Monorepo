// Prisma Schema - Cervak Framework
// PostgreSQL 17/18 con soporte UUID v7
// Clean Architecture + Soft Delete
// Prisma 7.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ADMINISTRATORS
// ============================================
model Administrator {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fullName          String    @map("full_name") @db.VarChar(255)
  emailAddress      String    @unique @map("email_address") @db.VarChar(255)
  username          String    @unique @db.VarChar(100)
  password          String    @db.VarChar(255)
  enabled           Boolean   @default(true)
  refreshToken      String?   @map("refresh_token") @db.Text
  recoverPasswordID String?   @map("recover_password_id") @db.VarChar(255)
  modules           Json?     @db.JsonB // Permisos y módulos asignados

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(3)

  // Relaciones polimórficas con Chat
  conversationMembers ConversationMember[] @relation("AdminConversations")
  messages            Message[]            @relation("AdminMessages")

  // Audit Log
  auditLogs         AuditLog[]           @relation("AdminAuditLogs")

  // Usuarios operativos creados por este administrador
  operativeUsers    OperativeUser[]      @relation("OperativeUserCreatedBy")

  @@index([emailAddress])
  @@index([username])
  @@index([deletedAt])
  @@map("administrators")
}

// ============================================
// USERS
// ============================================
model User {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fullName            String    @map("full_name") @db.VarChar(255)
  emailAddress        String    @unique @map("email_address") @db.VarChar(255)
  username            String    @unique @db.VarChar(100)
  password            String    @db.VarChar(255)
  online              Boolean   @default(false)
  language            String    @default("es") @db.VarChar(10)
  picture             String?   @db.Text // URL de la imagen de perfil
  location            Json?     @db.JsonB // { lat: number, lng: number }

  // WebAuthn Biometrics
  biometricChallenge  String?   @map("biometric_challenge") @db.Text
  registrationInfo    Json?     @map("registration_info") @db.JsonB // SimpleWebAuthn credential data

  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt           DateTime? @map("deleted_at") @db.Timestamptz(3)

  // Relaciones polimórficas con Chat
  conversationMembers ConversationMember[] @relation("UserConversations")
  messages            Message[]            @relation("UserMessages")

  // Notifications
  notifications       Notification[]

  // Audit Log
  auditLogs           AuditLog[]           @relation("UserAuditLogs")

  @@index([emailAddress])
  @@index([username])
  @@index([online])
  @@index([deletedAt])
  @@map("users")
}

// ============================================
// CHAT SYSTEM (Polimórfico)
// ============================================

// Conversación: individual, group, ai
model Conversation {
  id          String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type        ConversationType     @default(INDIVIDUAL)
  title       String?              @db.VarChar(255) // Para grupos
  picture     String?              @db.Text         // Para grupos
  metadata    Json?                @db.JsonB        // Datos adicionales

  createdAt   DateTime             @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt   DateTime             @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt   DateTime?            @map("deleted_at") @db.Timestamptz(3)

  // Relaciones
  members     ConversationMember[]
  messages    Message[]

  @@index([type])
  @@index([deletedAt])
  @@map("conversations")
}

enum ConversationType {
  INDIVIDUAL
  GROUP
  AI
}

// Tabla intermedia polimórfica: USER o ADMIN
model ConversationMember {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  memberId       String       @map("member_id") @db.Uuid
  memberType     MemberType   @map("member_type")

  // Metadata del miembro en la conversación
  role           String?      @db.VarChar(50) // admin, member, viewer
  lastReadAt     DateTime?    @map("last_read_at") @db.Timestamptz(3)
  mutedUntil     DateTime?    @map("muted_until") @db.Timestamptz(3)

  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt      DateTime?    @map("deleted_at") @db.Timestamptz(3)

  // Relaciones
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Relaciones polimórficas
  user           User?        @relation("UserConversations", fields: [memberId], references: [id], map: "conversation_members_user_fkey")
  administrator  Administrator? @relation("AdminConversations", fields: [memberId], references: [id], map: "conversation_members_admin_fkey")

  @@unique([conversationId, memberId, memberType])
  @@index([conversationId])
  @@index([memberId, memberType])
  @@index([deletedAt])
  @@map("conversation_members")
}

enum MemberType {
  USER
  ADMIN
}

// Mensajes
model Message {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String        @map("conversation_id") @db.Uuid
  authorId       String        @map("author_id") @db.Uuid
  authorType     MemberType    @map("author_type")

  content        String        @db.Text
  type           MessageType   @default(TEXT)
  read           Boolean       @default(false)

  // Reply functionality
  replyToId      String?       @map("reply_to_id") @db.Uuid

  // Attachments
  attachments    Json?         @db.JsonB // [{ url, type, name, size }]

  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt      DateTime?     @map("deleted_at") @db.Timestamptz(3)

  // Relaciones
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo        Message?      @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]     @relation("MessageReplies")

  // Relaciones polimórficas
  userAuthor     User?         @relation("UserMessages", fields: [authorId], references: [id], map: "messages_user_author_fkey")
  adminAuthor    Administrator? @relation("AdminMessages", fields: [authorId], references: [id], map: "messages_admin_author_fkey")

  @@index([conversationId])
  @@index([authorId, authorType])
  @@index([read])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("messages")
}

enum MessageType {
  TEXT
  FILE
  INFO // Mensajes del sistema (usuario unido, usuario salió, etc.)
}

// ============================================
// AUDIT LOG
// ============================================
model AuditLog {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action    String       @db.VarChar(255) // "user.login", "admin.delete_user", etc.
  level     LogLevel     @default(INFO)
  message   String       @db.Text

  // Actor polimórfico
  actorId   String?      @map("actor_id") @db.Uuid
  actorType ActorType?   @map("actor_type")

  // Contexto
  ip        String?      @db.VarChar(45) // IPv4 o IPv6
  userAgent String?      @map("user_agent") @db.Text
  meta      Json?        @db.JsonB // Datos adicionales

  createdAt DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)

  // Relaciones polimórficas
  user          User?          @relation("UserAuditLogs", fields: [actorId], references: [id], map: "audit_logs_user_actor_fkey")
  administrator Administrator? @relation("AdminAuditLogs", fields: [actorId], references: [id], map: "audit_logs_admin_actor_fkey")
  operativeUser OperativeUser? @relation("OperativeUserAuditLogs", fields: [actorId], references: [id], map: "audit_logs_operative_user_actor_fkey")

  @@index([action])
  @@index([level])
  @@index([actorId, actorType])
  @@index([createdAt])
  @@map("audit_logs")
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

enum ActorType {
  USER
  ADMIN
  OPERATIVE_USER
  SYSTEM
}

// ============================================
// ACTIONS & NOTIFICATIONS
// ============================================

// Acciones: push, socket, deep-link
model Action {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type        ActionType
  target      String       @db.VarChar(255) // User ID, topic, channel, etc.
  payload     Json         @db.JsonB // Datos de la acción

  executed    Boolean      @default(false)
  executedAt  DateTime?    @map("executed_at") @db.Timestamptz(3)
  error       String?      @db.Text

  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt   DateTime?    @map("deleted_at") @db.Timestamptz(3)

  @@index([type])
  @@index([target])
  @@index([executed])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("actions")
}

enum ActionType {
  PUSH         // Push notification
  SOCKET       // Socket.IO event
  DEEP_LINK    // Deep link / redirect
  EMAIL        // Email notification
  SMS          // SMS notification
}

// Notificaciones para usuarios
model Notification {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String       @map("user_id") @db.Uuid

  title       String       @db.VarChar(255)
  body        String       @db.Text
  picture     String?      @db.Text // URL de imagen
  payload     Json?        @db.JsonB // Datos adicionales (deep link, etc.)

  read        Boolean      @default(false)
  readAt      DateTime?    @map("read_at") @db.Timestamptz(3)

  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt   DateTime?    @map("deleted_at") @db.Timestamptz(3)

  // Relaciones
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("notifications")
}

// ============================================
// OPERATIVE USERS (Personal Operativo)
// ============================================
model OperativeUser {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fullName          String    @map("full_name") @db.VarChar(255)
  emailAddress      String    @unique @map("email_address") @db.VarChar(255)
  username          String    @unique @db.VarChar(100)
  password          String    @db.VarChar(255)
  enabled           Boolean   @default(true)
  refreshToken      String?   @map("refresh_token") @db.Text
  recoverPasswordID String?   @map("recover_password_id") @db.VarChar(255)

  // Administrador que creó/gestiona este usuario
  createdById       String?   @map("created_by_id") @db.Uuid

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(3)

  // Relaciones
  createdBy         Administrator? @relation("OperativeUserCreatedBy", fields: [createdById], references: [id])

  // Audit Log
  auditLogs         AuditLog[] @relation("OperativeUserAuditLogs")

  // Relevamientos de precios realizados por este usuario
  priceRecords      PriceRecord[]

  @@index([emailAddress])
  @@index([username])
  @@index([enabled])
  @@index([createdById])
  @@index([deletedAt])
  @@map("operative_users")
}

// ============================================
// PRODUCTS (Productos)
// ============================================
model Product {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String    @db.VarChar(255)
  description       String?   @db.Text
  brand             String?   @db.VarChar(100)
  presentation      String    @db.VarChar(100) // Ej: "1kg", "500g", "1L", "unidad"
  price             Decimal   @db.Decimal(12, 2)

  // Estado
  active            Boolean   @default(true)

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(3)

  // Relación con relevamientos de precios
  priceRecords      PriceRecord[]

  @@unique([name, presentation]) // Prevención de duplicados: mismo nombre + presentación
  @@index([name])
  @@index([brand])
  @@index([active])
  @@index([deletedAt])
  @@map("products")
}

// ============================================
// STORES (Locales)
// ============================================
model Store {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String    @db.VarChar(255)
  locality          String    @db.VarChar(100) // Localidad
  zone              String?   @db.VarChar(100) // Zona (opcional)

  // Estado - todos activos por defecto
  active            Boolean   @default(true)

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(3)

  // Relación con relevamientos de precios
  priceRecords      PriceRecord[]

  @@unique([name, locality]) // Prevención de duplicados: mismo nombre + localidad
  @@index([name])
  @@index([locality])
  @@index([zone])
  @@index([active])
  @@index([deletedAt])
  @@map("stores")
}

// ============================================
// PRICE RECORDS (Relevamientos de Precios)
// ============================================
model PriceRecord {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Producto relevado
  productId         String    @map("product_id") @db.Uuid

  // Local donde se relevó
  storeId           String    @map("store_id") @db.Uuid

  // Usuario operativo que realizó el relevamiento
  operativeUserId   String    @map("operative_user_id") @db.Uuid

  // Precio relevado
  price             Decimal   @db.Decimal(12, 2)

  // Fecha del relevamiento
  recordedAt        DateTime  @map("recorded_at") @db.Timestamptz(3)

  // Notas adicionales
  notes             String?   @db.Text

  // Foto del precio (opcional)
  photoUrl          String?   @map("photo_url") @db.Text

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(3)

  // Relaciones
  product           Product        @relation(fields: [productId], references: [id])
  store             Store          @relation(fields: [storeId], references: [id])
  operativeUser     OperativeUser  @relation(fields: [operativeUserId], references: [id])

  @@index([productId])
  @@index([storeId])
  @@index([operativeUserId])
  @@index([recordedAt])
  @@index([deletedAt])
  @@map("price_records")
}
